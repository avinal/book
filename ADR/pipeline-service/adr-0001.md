# 1. Record architecture decisions

Date: Oct 5, 2022

## Status

Proposed

## Context



## Decision

The service account used for running a PipelineRun workload in a workload cluster needs to have the right SCCs and linked credentials to be able to successfully
do execute a container image build. The linked credentials will mostly originate from the KCP workspace where the PipelineRun was synced from.
Additionally, the SCC association needed for elevating capabilities required for image builds isn't something we'd prefer to expose the user to.

## Consequences


### Implementation - AppStudio Build Service Controller

* AppStudioBuildService creates an "image-builder" service account in the KCP workspace/namespace.
* AppStudioBuildService links the image pull secret ( previously created by SPI ) with the "image-builder" service account in the KCP workspace/namespace. Upon doing so, the 'updated'
 "image-builder" service account gets synced into the workload cluster.
* AppStudioBuildService" creates the PipelineRun referencing the "image-builder" service account as the one that the PipelineRun/TaskRun `Pods` would run 
 as.
* And that's it! Since the [cluster]rolebinding in the Workload cluster for all "image-builder" service accounts would be pre-configured with the scc needed
 to build container images, the image should be successfully assembled.


### Implementation - Pipeline Service 

* The contract/API between users and the platform is the "image-builder" service account which users would be expected to use in the KCP workspace 
for PipelineRuns if they wish to build container images.
* The Pipeline Service platform would configure workload clusters with the [cluster]rolebindings necessary to have the "image-builder" service account 
configured with a tailor-made SCC such that they are sufficiently capable of building container images. 


### Security 

* As a platform feature, the Pipeline Service would allow users of the service ( AppStudio, HACBS, foo-bar ) to build container images. 
* Users should not be able to alter role bindings in their namespaces in a way that they are synced into the workload clusters. This will prevent SCC escalations by the
 users/services whose workloads would be scheduled on the PipelineService workload cluster.


See Michael Nygard's article, linked above.
